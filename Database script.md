**CODES USED TO CREATE THE WHOLE DATABASE**

***1. CREATE PLUGGABLE DATABASE***

CREATE PLUGGABLE DATABASE final_project_27683

ADMIN USER daniel_final_project_27683 IDENTIFIED BY daniel123

FILE_NAME_CONVERT=(

'C:\ORACLE21C\ORADATA\ORCL\PDBSEED',

'C:\ORACLE21C\ORADATA\ORCL\final_project_27683'
);

ALTER PLUGGABLE DATABASE final_project_27683 OPEN;

ALTER PLUGGABLE DATABASE final_project_27683 SAVE STATE;

ALTER SESSION SET CONTAINER = final_project_27683;

***2. CREATE TABLESPACE***

CREATE TABLESPACE USERS

DATAFILE 'C:\ORACLE21C\ORADATA\ORCL\final_project_27683\users01.dbf'

SIZE 200M AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED;

***3. CREATE PROJECT ADMIN USER***

CREATE USER PROJECT_ADMIN IDENTIFIED BY daniel123

DEFAULT TABLESPACE USERS

TEMPORARY TABLESPACE TEMP

QUOTA UNLIMITED ON USERS;

GRANT CONNECT, RESOURCE, CREATE SESSION, CREATE TABLE, CREATE VIEW,

CREATE PROCEDURE, CREATE TRIGGER, CREATE SEQUENCE, CREATE TYPE,

UNLIMITED TABLESPACE TO PROJECT_ADMIN;

ALTER SESSION SET CURRENT_SCHEMA = PROJECT_ADMIN;

***4. CORE TABLES***

CREATE TABLE REGION (

Region_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

RegionName VARCHAR2(100) NOT NULL,

Location VARCHAR2(150),

Description VARCHAR2(300)
);

CREATE TABLE MINERALS (

Mineral_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

MineralName VARCHAR2(100) NOT NULL,

Category VARCHAR2(80)
);

CREATE TABLE SITES (

Site_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

Region_id NUMBER NOT NULL,

SiteName VARCHAR2(100) NOT NULL,

Depth NUMBER,

CONSTRAINT fk_sites_region FOREIGN KEY (Region_id)

REFERENCES REGION(Region_id)
);

CREATE TABLE FINDINGS (

Finding_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

Site_id NUMBER NOT NULL,

Mineral_id NUMBER NOT NULL,

Quantity NUMBER,

FindingDate DATE,

CONSTRAINT fk_findings_site FOREIGN KEY (Site_id) REFERENCES SITES(Site_id),

CONSTRAINT fk_findings_mineral FOREIGN KEY (Mineral_id) REFERENCES MINERALS(Mineral_id)
);

CREATE TABLE SURVEYOR (

Surveyor_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

FullName VARCHAR2(100) NOT NULL,

Email VARCHAR2(100)
);

CREATE TABLE REPORT (

Report_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

Site_id NUMBER NOT NULL,

Surveyor_id NUMBER NOT NULL,

ReportDate DATE,

Summary CLOB,

CONSTRAINT fk_report_site FOREIGN KEY (Site_id) REFERENCES SITES(Site_id),

CONSTRAINT fk_report_surveyor FOREIGN KEY (Surveyor_id) REFERENCES SURVEYOR(Surveyor_id)
);

***5. HOLIDAY & AUDIT TABLES***

CREATE TABLE PUBLIC_HOLIDAYS (

Holiday_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

Holiday_date DATE NOT NULL,

Description VARCHAR2(100)
);

CREATE TABLE BUSINESS_AUDIT_LOG (

Log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

Username VARCHAR2(50),

Operation VARCHAR2(10),

TableName VARCHAR2(50),

AttemptDate DATE,

Status VARCHAR2(10),

Reason VARCHAR2(200)
);

***6. FUNCTIONS***

CREATE OR REPLACE FUNCTION FN_RESTRICT_DML

RETURN VARCHAR2 AS

v_day VARCHAR2(10);

v_cnt NUMBER;

BEGIN

v_day := TO_CHAR(SYSDATE,'DY','NLS_DATE_LANGUAGE=ENGLISH');

IF v_day IN ('MON','TUE','WED','THU','FRI') THEN

    RETURN 'WEEKDAY';

END IF;

SELECT COUNT(*) INTO v_cnt

FROM PUBLIC_HOLIDAYS

WHERE TRUNC(Holiday_date) = TRUNC(SYSDATE)

  AND Holiday_date <= ADD_MONTHS(TRUNC(SYSDATE),1);

IF v_cnt > 0 THEN

    RETURN 'HOLIDAY';

END IF;

RETURN 'ALLOWED';

END;

/

CREATE OR REPLACE FUNCTION FN_TOTAL_MINERAL_BY_REGION(p_region NUMBER)

RETURN NUMBER AS

total_qty NUMBER;

BEGIN

SELECT SUM(f.Quantity)

INTO total_qty

FROM FINDINGS f JOIN SITES s ON s.Site_id = f.Site_id

WHERE s.Region_id = p_region;

RETURN NVL(total_qty,0);

END;
/

***7. AUDIT LOG PROCEDURE***

CREATE OR REPLACE PROCEDURE PR_LOG_AUDIT(

p_table VARCHAR2,

p_op VARCHAR2,

p_status VARCHAR2,

p_reason VARCHAR2
) AS

BEGIN

INSERT INTO BUSINESS_AUDIT_LOG

VALUES (DEFAULT,

SYS_CONTEXT('USERENV','SESSION_USER'),

p_op, p_table, SYSDATE, p_status, p_reason);
COMMIT;
END;
/

***8. PACKAGE***

CREATE OR REPLACE PACKAGE PKG_MINING_OPERATIONS AS

PROCEDURE SAFE_ADD_FINDING(p_site NUMBER, p_mineral NUMBER, p_qty NUMBER);

FUNCTION GET_SITE_TOTAL(p_site NUMBER) RETURN NUMBER;

END;
/
CREATE OR REPLACE PACKAGE BODY PKG_MINING_OPERATIONS AS

FUNCTION GET_SITE_TOTAL(p_site NUMBER) RETURN NUMBER IS

total_qty NUMBER;

BEGIN

SELECT SUM(Quantity) INTO total_qty FROM FINDINGS WHERE Site_id = p_site;

RETURN NVL(total_qty,0);

END;

PROCEDURE SAFE_ADD_FINDING(p_site NUMBER, p_mineral NUMBER, p_qty NUMBER) IS
e_invalid_qty EXCEPTION;

BEGIN
IF p_qty <= 0 THEN RAISE e_invalid_qty; END IF;

INSERT INTO FINDINGS VALUES (DEFAULT, p_site, p_mineral, p_qty, SYSDATE);

COMMIT;

EXCEPTION

WHEN e_invalid_qty THEN

DBMS_OUTPUT.PUT_LINE('Invalid quantity');

WHEN OTHERS THEN

ROLLBACK;

END;

END PKG_MINING_OPERATIONS;
/

***9. TRIGGERS***

CREATE OR REPLACE TRIGGER TRG_FINDINGS_RESTRICT

BEFORE INSERT OR UPDATE OR DELETE ON FINDINGS

FOR EACH ROW

DECLARE

v_res VARCHAR2(20);

BEGIN

v_res := FN_RESTRICT_DML;

IF v_res <> 'ALLOWED' THEN

    PR_LOG_AUDIT('FINDINGS', ORA_SYSEVENT, 'DENIED', v_res);
    
    RAISE_APPLICATION_ERROR(-20001,'DML blocked: '||v_res);

ELSE

    PR_LOG_AUDIT('FINDINGS', ORA_SYSEVENT, 'ALLOWED', 'Weekend allowed');

END IF;

END;
/
CREATE OR REPLACE TRIGGER TRG_REPORT_COMPOUND

FOR INSERT OR UPDATE OR DELETE ON REPORT

COMPOUND TRIGGER

v_res VARCHAR2(20);

BEFORE STATEMENT IS

BEGIN

v_res := FN_RESTRICT_DML;

IF v_res <> 'ALLOWED' THEN

PR_LOG_AUDIT('REPORT', ORA_SYSEVENT, 'DENIED', v_res);

RAISE_APPLICATION_ERROR(-20002,'Operation blocked: '||v_res);

END IF;

END BEFORE STATEMENT;

AFTER EACH ROW IS

BEGIN

PR_LOG_AUDIT('REPORT', ORA_SYSEVENT, 'ALLOWED', 'Weekend allowed');

END AFTER EACH ROW;

END;
/

***10. SEED DATA***

INSERT INTO REGION VALUES (DEFAULT,'North Valley','Rwanda','Mountain mineral zone');

INSERT INTO REGION VALUES (DEFAULT,'East Ridge','Rwanda','Dry mineral belt');

INSERT INTO MINERALS VALUES (DEFAULT,'Gold','Metal');

INSERT INTO MINERALS VALUES (DEFAULT,'Tin','Metal');

INSERT INTO MINERALS VALUES (DEFAULT,'Quartz','Crystal');

COMMIT;
